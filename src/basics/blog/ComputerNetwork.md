[TOC]

## 基础部分

应用层：HTTP、FTP、Telnet、DNS、SMTP等。

传输层：TCP（Transmission Control Protocol）、UDP。

网络层： IP 协议（Internet Protocol） ：**寻址**（配合子网掩码计算出 IP 地址的网络号和主机号）和**路由**。

网络接口层：MAC 头部是以太网使用的头部，它包含了接收方和发送方的 MAC 地址等信息，可以通过 ARP 协议获取对方的 MAC 地址。

![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619154523663-1268348669.png)


### 键入网址后发生了什么
1. 浏览器解析URL（协议、域名、文件路径），生成**HTTP**请求信息：请求行+消息头（+消息体）
2. **DNS**域名解析：浏览器缓存、操作系统缓存、本机缓存、本地DNS服务器解析+缓存，根及其下级DNS服务器
3. 调用Socket库，委托协议栈工作：TCP/UDP、IP（ICMP（错误通知+信息查询）、ARP（IP->MAC））
4. **TCP**可靠传输：报文头部格式，包含端口号信息；三次握手确保双方都有发送和接收数据的能力、并初始化序列号，数据以MSS(=MTU-TCP头部-IP头部)长度切割
5. **IP**：封装网络包，包含IP地址信息，根据路由表（目标地址、子网掩码）选择网卡
6. **MAC头部**：目标MAC地址使用**ARP协议**在以太网中以广播的形式问询，并缓存，用于两点之间的传输
7. 网卡驱动程序+网卡：加上报头等信息，数据信息转换为电信号，发送！
8. 交换机（不具有MAC地址）：原样转发网络包，根据 MAC 地址表查找 MAC 地址，然后将信号发送到相应的端口
9. 路由器（具有MAC地址）：根据路由表判断转发目标，重复6-9
10. 数据包解析。
    ![image](https://img2020.cnblogs.com/blog/2098130/202111/2098130-20211121173603451-1596823112.png)
    ![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619160528719-1729420957.png)

#### DNS（Domain Name System）
DNS，域名系统，属于应用层协议，为其他应用层协议（HTTP、SMTP、FTP等）工作。通过DNS将域名解析为IP地址，因为网络通讯大多基于TCP/IP，而TCP/IP是基于IP地址的。  
因为传输效率，下层使用UDP传输协议，只会在UDP报文中表明有截断的时候使用TCP查询。  
![image](https://img2020.cnblogs.com/blog/2098130/202111/2098130-20211121164042793-1440974412.png)
如图，查找顺序为浏览器缓存——hosts文件——本地DNS解析器缓存——网络配置中的本地DNS服务器（区域资源+缓存）——转发模式找上级，否则迭代查询（根域、顶级域...）直至返回结果。  
参考：https://www.zhihu.com/question/23042131

#### Linux 系统是如何收发网络包的？

**网卡**专门负责接收和发送网络包，当网卡接收到一个网络包后，会通过 DMA 技术，将网络包放入到 Ring Buffer 中。为避免多次中断通知OS带来性能开销，采用**中断唤醒数据接收的服务程序、然后 poll 的方法来轮询数据**，唤醒后、读完前会暂时屏蔽中断，达到一次中断处理多个网络包的目的。

![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619161516445-694550346.png)

![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619161110012-2027483869.png)

### HTTP 超文本传输协议
常见状态码：200 OK、204 No Content、301 Moved Permanently、302 Found、304 Not Modified、400 Bad Request 笼统错误、403 Forbidden、404 Not Found、502 Bad Gateway、503 Service Unavailable。
![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619162008388-1333816896.png)

**GET 和 POST 有什么区别？**
1. 语义、参数位置、URL只支持 ASCII 字符、浏览器对URL长度有限制；
2. 语义上来说，GET 方法是安全（不会「破坏」服务器上的资源）、幂等、可被缓存的（浏览器、代理等）；POST 不安全，不幂等，（大部分实现）不可缓存。但实际不一定。

**HTTP 缓存实现方式**：
1. 强制缓存：**Cache-Control** 相对时间、Expires 绝对时间。
2. 协商缓存：Last-Modified、ETag。再次请求返回 304 或 200。协商缓存这两个字段都需要配合强制缓存中 Cache-control 字段来使用，只有在未能命中强制缓存的时候，才能发起带有协商缓存字段的请求。
   ![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619163519639-1322996510.png)


**HTTP 1.1 特性**
优点：简单、灵活和易于扩展、应用广泛和跨平台。
缺点：无状态双刃剑、明文传输双刃剑、不安全（通信明文、没有身份验证、无法证明报文完整性）。
性能：长连接、管道网络传输（发起多个请求，服务端顺序处理可能引起**队头堵塞**）、队头堵塞。

**HTTP/1.1如何优化？**
1. 尽量避免发送 HTTP 请求：缓存；
2. 减少请求次数：减少重定向请求（代理服务器完成重定向、301 308 缓存重定向）、合并请求、延迟发送请求；
3. HTTP 响应的数据大小：有损压缩、无损压缩。


#### HTTPS
背景：解决前面HTTP的不安全点（通信明文、没有身份验证、无法证明报文完整性）。
HOW：收到客户端发送的请求（随机数、支持的密码套件）后，服务端生成随机数、选择密码套件、返回CA机构申请的、带服务器公钥和数字签名的CA证书，客户端用浏览器保存的CA公钥解密数字签名，与计算hash(证书明文信息)得到的结果进行验证，然后用服务器公钥加密自己使用密码套件、根据3个随机数生成的对称密钥k、发给服务端，双方用此密钥进行加密通信。在此过程中，系统或浏览器内置的CA机构的证书和公钥至关重要。
Q：两对非对称密钥呢？A：主要因为非对称加解密耗时远大于对称。
![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619165806508-1161442953.png)
![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619165812484-152968019.png)

**HTTPS 如何优化**
https://xiaolincoding.com/network/2_http/https_optimize.html
![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619173543341-548253734.png)


**HTTP 1.1、2、3 演变**
1. HTTP 1.1
   改进：长连接、管道网络传输。
   不足：只能压缩 Body 的部分、头部冗余、请求顺序响应可能导致队头堵塞、没有请求优先级控制、服务器只能被动响应。
2. HTTP 2
   改进：基于HTTPS更安全、HPACK 头部压缩、报文采用**二进制格式**增加传输效率、Stream 数据流（不必按顺序，可指定优先级）、多路复用、服务器主动推送。
   不足：虽然可以 Stream 并发，但 TCP 层必须保证收到的字节数据是完整且连续的，还是可能导致队头阻塞。
3. HTTP 3
   改进：TCP->UDP+QUIC。QUIC 协议 可以实现类似 TCP 的可靠性传输。
   1. 无队头阻塞：当某个流发生丢包时，只会阻塞这个流；
   2. 连接建立更快：三次握手中融入安全连接信息；
   3. 连接迁移：通过连接ID而非IP端口四元组确定一个连接， IP 地址变化时连接不变。


## TCP（Transmission Control Protocol）
TCP，传输控制协议，是面向连接的、可靠的、基于字节流的传输层通信协议。
TCP连接：保证可靠传输、流量控制，包括Socket（IP+端口）、序列号、窗口大小。IP端口四元组确定一个TCP连接。

**TCP 和 UDP 区别**：TCP 有连接、传输可靠、拥塞控制和流量控制，UDP 都没有、尽力交付；TCP 一对一，UDP 一对一、一对多、多对多；TCP 首部开销更大。

**TCP 和 UDP 应用场景**：TCP 适合 FTP、HTTP，UDP 适合 DNS、音视频通信、广播通信。

**三次握手**，第三次可携带数据。为什么三次握手才可以初始化Socket、序列号和窗口大小并建立 TCP 连接？两次握手：无法防止历史连接的建立，会造成双方资源的浪费（因网络阻塞服务器每次收到SYN都建立新连接），也无法可靠的同步双方序列号。
![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619192403734-1914049974.png)

第一次握手丢失了，会发生什么？客户端超时重传。
第二次握手丢失了，会发生什么？客户端、服务端超时重传。
第三次握手丢失了，会发生什么？服务端超时重传（ACK 报文不会重传）。

![image](https://img2020.cnblogs.com/blog/2098130/202111/2098130-20211121191014272-117295767.png)
IP层也会分片，为啥TCP层要分片？因为是由TCP保证可靠传输，如果完全依赖IP层分片，缺失一小片就得全部重传，所以TCP预先以MSS分片。

SYN攻击：伪造不同 IP 地址的 SYN 报文，占满服务端的半连接队列。
1. 内核参数设置队列大小和队满策略；
2. 不放入半连接队列，而是生成 tcp_syncookies 当做序列号发给客户端，收到再进行验证和放入全连接队列。

**四次挥手**：主动关闭连接的，才有 TIME_WAIT 状态，时间为2MSL（报文最大生存时间），一来一回的最长时间。作用：保证被动方的连接正确关闭；防止旧连接的数据包被新连接错误接收（2MSL后都丢弃了）。

第一次挥手丢失了，会发生什么？主动方超时重传，超过 tcp_orphan_retries 次后直接 close。
第二次挥手丢失了，会发生什么？ACK不重传，主动方等待 tcp_fin_timeout 后直接关闭。
第三次挥手丢失了，会发生什么？被动方超时重传，直到 tcp_orphan_retries 次。
第四次挥手丢失了，会发生什么？被动方超时重传，直到 tcp_orphan_retries 次。

TIME_WAIT 过多占用端口和内存资源，怎么优化：tcp_tw_reuse 复用端口；tcp_max_tw_buckets 设置TW最长时间；SO_LINGER 直接调用 close 关闭连接。

![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619194747041-1319577072.png)
![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619194752078-958996781.png)

[重传机制、滑动窗口、流量控制、拥塞控制](https://mp.weixin.qq.com/s/HjOUsKn8eLfDogbBX3hPnA)
![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619195214721-1614464081.png)
**重传机制**
超时重传：数据包丢失和确认应答丢失都会触发。超时重传时间（RTO）应该略大于 RTT（Round-Trip Time 往返时延）。不足：超时周期可能相对较长。
快速重传：当收到三个相同的 ACK 报文时，会在定时器过期之前，重传丢失的报文段。不足：重传之前的一个还是所有？
SACK（选择性确认）：接收方将缓存的 map 发送给发送方，就知道哪些没收到了。
D-SACK（Duplicate SACK）：使用 SACK 告诉「发送方」有哪些数据被重复接收了。

**滑动窗口**
窗口大小：无需等待确认应答，可以继续发送数据的最大值。通常由接收方的窗口大小来决定，约等于发送窗口的大小。

**流量控制**
让「发送方」根据「接收方」的实际接收能力控制发送的数据量。
TCP 规定不允许同时减少缓存又收缩窗口，而是采用先收缩窗口、过段时间再减少缓存，可以避免丢包情况。

如何解决窗口关闭时，潜在的死锁现象？
![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619201720887-1647155668.png)

**流量控制**
慢启动、拥塞避免、快速恢复
**慢启动**：拥塞窗口 cwnd 初始为 1，cwnd < ssthresh 时，收到 ACK 后 cwnd 翻倍；
**拥塞避免**：cwnd >= ssthresh 时，收到 ACK 后 cwnd += 1；
**拥塞发生**：
1. 超时重传：ssthresh = cwnd/2，cwnd 重置为 1，进入慢启动。
2. 快速重传：ssthresh = cwnd/2，cwnd = ssthresh，进入**快速恢复**（即拥塞避免）。
![image](https://img2020.cnblogs.com/blog/2098130/202111/2098130-20211121203259329-1044000153.png)

**TCP Keepalive 和 HTTP Keep-Alive 是一个东西吗？**
HTTP 的 Keep-Alive，是由应用层（用户态） 实现的，使得用同一个 TCP 连接来发送和接收多个 HTTP 请求/应答，称为 **HTTP 长连接**；
TCP 的 Keepalive，是由 TCP 层（内核态） 实现的，长时间没有数据交互时，内核发送探测报文检测对方是否还在线，称为 **TCP 保活机制**。

**TCP 协议有哪些缺陷**
升级 TCP 的工作很困难；
TCP 建立连接的延迟；
TCP 存在队头阻塞问题；
网络迁移需要重新建立 TCP 连接。

**如何基于 UDP 协议实现可靠传输？QUIC 协议**
可靠传输：
Packet Header：三次握手确定连接ID，Packet Number 单调递增更加精确计算 RTT、支持乱序确认。
QUIC Frame Header：Stream ID + Offset 字段信息支持乱序确认。

解决 TCP 队头阻塞问题：QUIC 给每个 Stream 都分配了一个独立的滑动窗口，多个 Stream 相互独立。

流量控制：告诉对端自己可以接收的字节数。包括 Stream 级别和 Connection 级别的控制。

对拥塞控制改进：QUIC 默认支持 TCP 拥塞控制算法，以及更多算法。QUIC 处于应用层，可以随浏览器更新、快速迭代，而且可以针对不同的应用设置不同的拥塞控制算法。

更快的连接建立。

网络迁移：连接 ID 不变。

![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619210659145-1745800046.png)


#### I/O模型
UNIX有5种I/O模型：
- 阻塞式：recvfrom()，只是进程（非操作系统）被阻塞，CPU利用率高
- 非阻塞式：不断轮询（polling），返回错误码或直到读取到数据，CPU利用率低
- I/O 复用（select、poll）：阻塞等待多个套接字，任一个变为可读时返回，使用recvfrom()读取。又称为事件驱动 I/O。相比多线程，系统开销更小。
    - select（最早）：fd连接数量限制，轮询、多次fd拷贝、结果遍历效率低；timeout精度更低、更适合实时性要求比较高的场景，可移植性好。
    - poll（略为改进）：连接无限制；实时性要求不高时用poll而非select。
    - epoll（大改进）：连接无限制，fd只拷贝一次，只返回有变化的fd链表；只支持Linux，大量描述符需要同时轮询，并且最好是长连接（fd存在内核中，频繁状态改变进行系统调用降低效率）时。
- 信号驱动式 I/O（SIGIO）：使用 sigaction 系统调用，立即返回；数据到达时发送SIGIO信号，recvfrom()读取。
- 异步 I/O（AIO）：使用 aio_read 系统调用，立即返回；内核完成所有操作后向进程发送信号。


## IP
网络层：实现主机与主机之间的通信，也叫点对点（end to end）通信。

IP 地址分类：ABC类包括网络号和主机号。主机号全为 1 指定某个网络下的所有主机，用于广播；主机号全为 0 指定某个网络，不用于分配。
![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619211232895-1893059847.png)
IP 分类的缺点：同一网络下没有地址层次；不能很好的与现实网络匹配。后续提出了无分类地址，即 CIDR。

公有 IP 地址与私有 IP 地址。

当 IP 数据包大小大于 MTU 时， IP 数据包就会被分片；只能由目标主机进行重组。

IP 协议相关技术：
- DNS 域名解析
- ARP 与 RARP 协议：由于主机的路由表中可以找到下一跳的 IP 地址，所以可以通过 ARP 协议，求得下一跳的 MAC 地址。RARP 协议：已知 MAC 地址求 IP 地址。
- DHCP 动态获取 IP 地址：全程都是使用 UDP 广播通信。DHCP **中继代理**，对不同网段的 IP 地址分配也可以由一个 DHCP 服务器统一进行管理。
- NAT 网络地址转换：NAT 穿透技术，客户端主动从 NAT 设备获取公有 IP 地址，然后自己建立端口映射条目、对外通信，从而不需要 NAT 设备来进行转换。
- ICMP 互联网控制报文协议：确认 IP 包是否成功送达目标地址、报告发送过程中 IP 包被废弃的原因和改善网络设置等。分类：查询报文类型（ping 命令）、差错报文类型（traceroute 应用：设置特殊的 TTL 出错以追踪沿途路由器、设置不分片确定路径的 MTU）。
- IGMP 因特网组管理协议：向路由器申请加入和退出组播组。

![image](https://img2022.cnblogs.com/blog/2098130/202206/2098130-20220619213727422-1484621436.png)
